---
phase: 06-qr-code-support
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/components/QRScanner/QRScanner.tsx
  - client/src/components/QRScanner/ScannerOverlay.tsx
  - client/src/components/QRScanner/useQRScanner.ts
autonomous: true

must_haves:
  truths:
    - "Scanner can read QR codes from device camera"
    - "Scanner has cutout overlay with dark edges"
    - "Scanner stops properly when unmounted"
  artifacts:
    - path: "client/src/components/QRScanner/QRScanner.tsx"
      provides: "Main scanner component with overlay"
      exports: ["QRScanner"]
    - path: "client/src/components/QRScanner/ScannerOverlay.tsx"
      provides: "Cutout overlay UI"
      exports: ["ScannerOverlay"]
    - path: "client/src/components/QRScanner/useQRScanner.ts"
      provides: "Scanner hook with lifecycle management"
      exports: ["useQRScanner"]
  key_links:
    - from: "client/src/components/QRScanner/useQRScanner.ts"
      to: "html5-qrcode"
      via: "Html5Qrcode class import"
      pattern: "import.*Html5Qrcode.*from.*html5-qrcode"
    - from: "client/src/components/QRScanner/QRScanner.tsx"
      to: "client/src/components/QRScanner/useQRScanner.ts"
      via: "hook usage"
      pattern: "useQRScanner"
---

<objective>
Create QR scanner component with custom cutout overlay using html5-qrcode.

Purpose: Provide camera-based QR scanning with the custom overlay UI specified in CONTEXT.md.
Output: QRScanner component, ScannerOverlay component, useQRScanner hook.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-qr-code-support/06-RESEARCH.md
@.planning/phases/06-qr-code-support/06-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useQRScanner hook</name>
  <files>client/src/components/QRScanner/useQRScanner.ts</files>
  <action>
Create the scanner hook with proper lifecycle management:

```typescript
// QRScanner/useQRScanner.ts - Scanner hook with Html5Qrcode class
import { useRef, useState, useCallback, useEffect } from 'react';
import { Html5Qrcode, Html5QrcodeScannerState } from 'html5-qrcode';

interface UseQRScannerOptions {
  onSuccess: (code: string) => void;
  onError?: (error: string) => void;
}

export function useQRScanner(containerId: string, { onSuccess, onError }: UseQRScannerOptions) {
  // Use useRef for scanner instance to avoid re-renders and StrictMode issues
  const scannerRef = useRef<Html5Qrcode | null>(null);
  const [isScanning, setIsScanning] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const start = useCallback(async () => {
    // Already have a scanner
    if (scannerRef.current) {
      const state = scannerRef.current.getState();
      if (state === Html5QrcodeScannerState.PAUSED) {
        scannerRef.current.resume();
        setIsScanning(true);
        return;
      }
      if (state === Html5QrcodeScannerState.SCANNING) {
        return; // Already scanning
      }
    }

    try {
      const scanner = new Html5Qrcode(containerId, { verbose: false });
      scannerRef.current = scanner;

      await scanner.start(
        { facingMode: 'environment' }, // Back camera, no 'exact' for iOS compatibility
        {
          fps: 10,
          qrbox: { width: 250, height: 250 },
        },
        (decodedText) => {
          onSuccess(decodedText);
        },
        () => {} // Silent callback for "no QR found" per-frame errors
      );

      setIsScanning(true);
      setError(null);
    } catch (err) {
      const message = err instanceof Error ? err.message : 'Camera access failed';
      setError(message);
      setIsScanning(false);
      onError?.(message);
    }
  }, [containerId, onSuccess, onError]);

  const stop = useCallback(async () => {
    const scanner = scannerRef.current;
    if (!scanner) return;

    try {
      const state = scanner.getState();
      if (state === Html5QrcodeScannerState.SCANNING ||
          state === Html5QrcodeScannerState.PAUSED) {
        await scanner.stop();
      }
      await scanner.clear();
    } catch (err) {
      console.warn('Scanner cleanup error:', err);
    } finally {
      scannerRef.current = null;
      setIsScanning(false);
    }
  }, []);

  // Cleanup on unmount
  useEffect(() => {
    return () => { stop(); };
  }, [stop]);

  return { start, stop, isScanning, error };
}
```

Key points from RESEARCH.md:
- Use useRef not useState for scanner (React StrictMode issue)
- Check state before stopping (avoid "not scanning" errors)
- No 'exact' constraint on facingMode (iOS Safari compatibility)
- Silent error callback for per-frame scanning
  </action>
  <verify>
`grep -l "Html5Qrcode" client/src/components/QRScanner/useQRScanner.ts` returns the file
  </verify>
  <done>useQRScanner hook created with proper lifecycle management</done>
</task>

<task type="auto">
  <name>Task 2: Create ScannerOverlay component</name>
  <files>client/src/components/QRScanner/ScannerOverlay.tsx</files>
  <action>
Create the cutout overlay per CONTEXT.md decision:

```typescript
// QRScanner/ScannerOverlay.tsx - Dark overlay with transparent scanning area
interface ScannerOverlayProps {
  error?: string | null;
}

export function ScannerOverlay({ error }: ScannerOverlayProps) {
  return (
    <div className="absolute inset-0 pointer-events-none">
      {/* Dark overlay with center cutout using clip-path */}
      <div
        className="absolute inset-0 bg-black/60"
        style={{
          clipPath: 'polygon(0% 0%, 0% 100%, 25% 100%, 25% 25%, 75% 25%, 75% 75%, 25% 75%, 25% 100%, 100% 100%, 100% 0%)'
        }}
      />

      {/* Corner brackets for scan area indication */}
      <div className="absolute top-1/4 left-1/4 w-1/2 h-1/2">
        {/* Top-left corner */}
        <div className="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 border-white rounded-tl-lg" />
        {/* Top-right corner */}
        <div className="absolute top-0 right-0 w-6 h-6 border-t-2 border-r-2 border-white rounded-tr-lg" />
        {/* Bottom-left corner */}
        <div className="absolute bottom-0 left-0 w-6 h-6 border-b-2 border-l-2 border-white rounded-bl-lg" />
        {/* Bottom-right corner */}
        <div className="absolute bottom-0 right-0 w-6 h-6 border-b-2 border-r-2 border-white rounded-br-lg" />
      </div>

      {/* Error message inside viewfinder */}
      {error && (
        <div className="absolute top-1/2 left-1/4 w-1/2 transform -translate-y-1/2 text-center">
          <p className="text-white text-sm bg-black/50 px-3 py-2 rounded">
            {error}
          </p>
        </div>
      )}
    </div>
  );
}
```

Per CONTEXT.md:
- Cutout overlay style: dark overlay with transparent scanning area in center
- Invalid QR: inline message in viewfinder ("Invalid code, try again")
  </action>
  <verify>
`grep -l "clip-path" client/src/components/QRScanner/ScannerOverlay.tsx` returns the file
  </verify>
  <done>ScannerOverlay component created with dark cutout and error message area</done>
</task>

<task type="auto">
  <name>Task 3: Create main QRScanner component</name>
  <files>client/src/components/QRScanner/QRScanner.tsx</files>
  <action>
Create the main scanner component that combines the hook and overlay:

```typescript
// QRScanner/QRScanner.tsx - Main scanner component with custom overlay
import { useEffect, useId } from 'react';
import { useQRScanner } from './useQRScanner';
import { ScannerOverlay } from './ScannerOverlay';

interface QRScannerProps {
  onScan: (code: string) => void;
  onError?: (error: string) => void;
  active: boolean;
}

export function QRScanner({ onScan, onError, active }: QRScannerProps) {
  const containerId = useId().replace(/:/g, ''); // Remove colons for valid HTML id
  const { start, stop, isScanning, error } = useQRScanner(containerId, {
    onSuccess: onScan,
    onError,
  });

  // Start/stop based on active prop
  useEffect(() => {
    if (active) {
      start();
    } else {
      stop();
    }
  }, [active, start, stop]);

  return (
    <div className="relative w-full h-full bg-black">
      {/* Camera feed container - html5-qrcode renders here */}
      <div
        id={containerId}
        className="w-full h-full"
        style={{ minHeight: '300px' }}
      />

      {/* Custom overlay on top of camera feed */}
      {isScanning && <ScannerOverlay error={error} />}

      {/* Camera permission denied / not available */}
      {!isScanning && error && (
        <div className="absolute inset-0 flex items-center justify-center bg-black">
          <p className="text-white text-center px-4">{error}</p>
        </div>
      )}
    </div>
  );
}
```

Key behaviors:
- Uses unique ID via useId() for multiple scanner instances
- Controlled via active prop
- Shows overlay when scanning
- Shows error state when camera unavailable
  </action>
  <verify>
`grep -l "useQRScanner" client/src/components/QRScanner/QRScanner.tsx` returns the file
  </verify>
  <done>QRScanner component created, combines hook and overlay, controlled via active prop</done>
</task>

</tasks>

<verification>
- `ls client/src/components/QRScanner/` shows QRScanner.tsx, ScannerOverlay.tsx, useQRScanner.ts
- Build passes: `cd client && pnpm build` (no TypeScript errors)
- All three files export their main component/hook
</verification>

<success_criteria>
- useQRScanner hook manages Html5Qrcode lifecycle with proper cleanup
- ScannerOverlay provides cutout overlay with error message area
- QRScanner component combines both with active prop control
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-qr-code-support/06-02-SUMMARY.md`
</output>
