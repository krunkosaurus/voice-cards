---
phase: 06-qr-code-support
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - client/src/components/ConnectionDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User sees QR code when displaying offer/answer code"
    - "User can scan QR code to enter connection code"
    - "Scan option hidden when no camera available"
    - "Text code fallback available next to QR"
  artifacts:
    - path: "client/src/components/ConnectionDialog.tsx"
      provides: "Enhanced connection dialog with QR support"
      contains: "QRCodeDisplay"
  key_links:
    - from: "client/src/components/ConnectionDialog.tsx"
      to: "client/src/components/QRCodeDisplay.tsx"
      via: "import and usage"
      pattern: "import.*QRCodeDisplay"
    - from: "client/src/components/ConnectionDialog.tsx"
      to: "client/src/components/QRScanner/QRScanner.tsx"
      via: "import and usage"
      pattern: "import.*QRScanner"
    - from: "client/src/components/ConnectionDialog.tsx"
      to: "client/src/hooks/useCameraAvailability.ts"
      via: "hook usage"
      pattern: "useCameraAvailability"
---

<objective>
Integrate QR code display and scanner into ConnectionDialog.

Purpose: Enable mobile users to display and scan QR codes as an alternative to copy-pasting long SDP codes.
Output: Enhanced ConnectionDialog with QR display for offers/answers and QR scanning capability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-qr-code-support/06-RESEARCH.md
@.planning/phases/06-qr-code-support/06-CONTEXT.md
@.planning/phases/06-qr-code-support/06-01-SUMMARY.md
@.planning/phases/06-qr-code-support/06-02-SUMMARY.md
@client/src/components/ConnectionDialog.tsx
@client/src/hooks/useMobile.tsx
@client/src/components/ui/drawer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QR display to offer/answer steps</name>
  <files>client/src/components/ConnectionDialog.tsx</files>
  <action>
Enhance the 'create-offer' and 'show-answer' steps to show QR code as primary with text fallback:

1. Import QRCodeDisplay and useCameraAvailability:
```typescript
import { QRCodeDisplay } from '@/components/QRCodeDisplay';
import { useCameraAvailability } from '@/hooks/useCameraAvailability';
```

2. In the 'create-offer' step (showing offer code), replace the Textarea with:
- QRCodeDisplay as primary (centered)
- Small icon button to reveal/copy text code as fallback
- Use a disclosure pattern: collapsed by default, expand to show text

```tsx
{step === 'create-offer' && (
  <>
    <DialogHeader>
      <DialogTitle>Share Your Code</DialogTitle>
      <DialogDescription>
        Have your peer scan this QR code, or copy the text code below.
      </DialogDescription>
    </DialogHeader>
    <div className="py-4 flex flex-col items-center gap-4">
      {/* QR code is primary */}
      {offerCode && (
        <div className="p-4 bg-white rounded-lg">
          <QRCodeDisplay code={offerCode} size={192} />
        </div>
      )}

      {/* Text code fallback with copy button */}
      <div className="flex items-center gap-2">
        <Button
          variant="outline"
          size="sm"
          onClick={() => offerCode && copyToClipboard(offerCode)}
        >
          {copied ? <Check className="w-4 h-4 mr-2" /> : <Copy className="w-4 h-4 mr-2" />}
          {copied ? 'Copied!' : 'Copy text code'}
        </Button>
      </div>
      {error && <p className="text-sm text-destructive">{error}</p>}
    </div>
    <DialogFooter>
      <Button variant="outline" onClick={() => setStep('enter-answer')}>
        I have their code
      </Button>
    </DialogFooter>
  </>
)}
```

3. Apply same pattern to 'show-answer' step (showing answer code)

Per CONTEXT.md:
- QR code is primary, text code is secondary
- Icon button next to QR reveals/copies text code as fallback
  </action>
  <verify>
`grep -l "QRCodeDisplay" client/src/components/ConnectionDialog.tsx` returns the file
  </verify>
  <done>QRCodeDisplay shown in create-offer and show-answer steps, text fallback via copy button</done>
</task>

<task type="auto">
  <name>Task 2: Add QR scanner to enter-offer step</name>
  <files>client/src/components/ConnectionDialog.tsx</files>
  <action>
Add scanning capability to the 'enter-offer' step (joining with code):

1. Add imports:
```typescript
import { QRScanner } from '@/components/QRScanner/QRScanner';
import { useCameraAvailability } from '@/hooks/useCameraAvailability';
import { Camera, Type } from 'lucide-react';
```

2. Add state for scan mode:
```typescript
const [scanMode, setScanMode] = useState(false);
const hasCamera = useCameraAvailability();
```

3. Modify 'enter-offer' step to support both scan and paste modes:

```tsx
{step === 'enter-offer' && (
  <>
    <DialogHeader>
      <DialogTitle>
        {scanMode ? 'Scan QR Code' : 'Enter Connection Code'}
      </DialogTitle>
      <DialogDescription>
        {scanMode
          ? 'Point your camera at the QR code'
          : 'Scan the QR code or paste the text code'
        }
      </DialogDescription>
    </DialogHeader>

    <div className="py-4 space-y-3">
      {scanMode ? (
        // Scanner view
        <div className="relative h-64 overflow-hidden rounded-lg">
          <QRScanner
            active={scanMode}
            onScan={(code) => {
              setInputCode(code);
              setScanMode(false);
              // Auto-submit on valid scan per CONTEXT.md
              handleSubmitOffer();
            }}
            onError={(err) => {
              // Camera error - fall back to paste mode
              setScanMode(false);
            }}
          />
        </div>
      ) : (
        // Text input view
        <>
          <Textarea
            value={inputCode}
            onChange={(e) => setInputCode(e.target.value)}
            placeholder="Paste connection code here..."
            className="font-mono text-xs h-24 resize-none break-all overflow-hidden"
          />
          {error && <p className="text-sm text-destructive">{error}</p>}
          <Button
            className="w-full"
            onClick={handleSubmitOffer}
            disabled={!inputCode.trim() || isLoading}
          >
            {isLoading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : null}
            Submit Code
          </Button>
        </>
      )}

      {/* Mode toggle - only show scan option if camera available */}
      {hasCamera !== null && (
        <div className="flex justify-center pt-2">
          {hasCamera && !scanMode && (
            <Button variant="ghost" size="sm" onClick={() => setScanMode(true)}>
              <Camera className="w-4 h-4 mr-2" />
              Scan QR instead
            </Button>
          )}
          {scanMode && (
            <Button variant="ghost" size="sm" onClick={() => setScanMode(false)}>
              <Type className="w-4 h-4 mr-2" />
              Paste text instead
            </Button>
          )}
        </div>
      )}
    </div>

    <DialogFooter>
      <Button variant="outline" onClick={() => { setScanMode(false); setStep('choose'); }}>
        Back
      </Button>
    </DialogFooter>
  </>
)}
```

Per CONTEXT.md:
- Auto-connect on valid scan (no confirmation prompt)
- Proactively check for camera before showing scan option - hide if unavailable
- Camera denied: show text paste fallback
  </action>
  <verify>
`grep -l "QRScanner" client/src/components/ConnectionDialog.tsx` returns the file
  </verify>
  <done>QRScanner integrated in enter-offer step, toggleable with camera check, auto-connects on scan</done>
</task>

<task type="auto">
  <name>Task 3: Handle scan mode state reset</name>
  <files>client/src/components/ConnectionDialog.tsx</files>
  <action>
Ensure scan mode resets properly:

1. Reset scanMode when dialog opens/closes:
```typescript
useEffect(() => {
  if (open && state === 'disconnected') {
    setStep('choose');
    setInputCode('');
    setCopied(false);
    setScanMode(false); // Add this
  } else if (open && state === 'connected') {
    setStep('connected');
  }
}, [open]);
```

2. Reset scanMode when leaving enter-offer step:
- Already handled by onClick handlers setting step

3. Handle auto-submit after scan properly:
The onScan handler should:
- Set the input code
- Disable scan mode
- Submit immediately

Adjust the handleSubmitOffer to work with scanned code:
```typescript
const handleSubmitOffer = async (codeOverride?: string) => {
  const code = codeOverride || inputCode.trim();
  if (!code) return;
  setIsLoading(true);
  await onAcceptOffer(code);
  setIsLoading(false);
  if (!error) {
    setStep('show-answer');
    setInputCode('');
    setScanMode(false);
  }
};
```

And in QRScanner onScan:
```typescript
onScan={(code) => {
  setScanMode(false);
  handleSubmitOffer(code);
}}
```
  </action>
  <verify>
`grep -l "setScanMode" client/src/components/ConnectionDialog.tsx` returns multiple occurrences
  </verify>
  <done>Scan mode properly resets on dialog open, step change, and successful scan</done>
</task>

</tasks>

<verification>
- Build passes: `cd client && pnpm build` (no TypeScript errors)
- QR code displays in 'create-offer' step when offerCode exists
- QR code displays in 'show-answer' step when answerCode exists
- Scan button appears in 'enter-offer' step only when camera available
- Scanner activates on click and auto-submits on successful scan
</verification>

<success_criteria>
- Offer code shows QR code as primary, copy button as fallback
- Answer code shows QR code as primary, copy button as fallback
- Scan option hidden when camera unavailable
- Scanning QR code auto-connects (CONN-06)
- Text paste still works as fallback (CONN-06)
</success_criteria>

<output>
After completion, create `.planning/phases/06-qr-code-support/06-03-SUMMARY.md`
</output>
