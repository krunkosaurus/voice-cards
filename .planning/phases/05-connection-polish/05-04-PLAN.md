---
phase: 05-connection-polish
plan: 04
type: execute
wave: 4
depends_on: ["05-03"]
files_modified:
  - client/src/components/SyncIndicator.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 'Reconnecting...' state when connection drops (CONN-07)"
    - "User sees 'Connection lost' message after brief reconnecting state"
    - "User can click disconnect button to end session (CONN-08)"
    - "User sees toast when connection is lost or peer disconnects (PRES-02)"
  artifacts:
    - path: "client/src/components/SyncIndicator.tsx"
      provides: "Enhanced badge with reconnecting state, popover with disconnect button, toast notifications"
      contains: "PopoverContent"
  key_links:
    - from: "client/src/components/SyncIndicator.tsx"
      to: "client/src/contexts/SyncContext.tsx"
      via: "useSync hook for reconnectionState, connectedAt, gracefulDisconnect"
      pattern: "useSync"
    - from: "client/src/components/SyncIndicator.tsx"
      to: "sonner"
      via: "toast.error, toast.info, toast.success"
      pattern: "toast\\."
---

<objective>
Enhance SyncIndicator with reconnecting state display, popover disconnect button, and toast notifications.

Purpose: Implement PRES-01 (peer connected indicator), PRES-02 (connection lost notification), CONN-07 UI (reconnecting state), and CONN-08 UI (disconnect button). User always knows connection state and can cleanly end sessions.

Output: Enhanced SyncIndicator component with popover showing connection info and disconnect button, plus toast notifications for connection events.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-connection-polish/05-CONTEXT.md
@.planning/phases/05-connection-polish/05-RESEARCH.md
@.planning/phases/05-connection-polish/05-01-SUMMARY.md
@.planning/phases/05-connection-polish/05-02-SUMMARY.md
@.planning/phases/05-connection-polish/05-03-SUMMARY.md
@client/src/components/SyncIndicator.tsx
@client/src/components/ui/popover.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reconnecting state and popover imports</name>
  <files>client/src/components/SyncIndicator.tsx</files>
  <action>
Update imports and add new state handling:

1. Update imports at the top:
```typescript
import { useEffect, useRef, useState } from 'react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Wifi, WifiOff, Loader2, AlertCircle, RefreshCw, X } from 'lucide-react';
import { toast } from 'sonner';
import type { ConnectionState } from '@/types/sync';
import { useSync } from '@/contexts/SyncContext';
```

2. Update SyncIndicatorProps - remove onDisconnect since we use context:
```typescript
interface SyncIndicatorProps {
  state: ConnectionState;
}
```

3. Update getStateConfig to handle 'reconnecting' state (add case before 'error'):
```typescript
case 'reconnecting':
  return {
    variant: 'secondary' as const,
    className: 'bg-orange-500/10 text-orange-600 hover:bg-orange-500/20 border-orange-500/30',
    icon: <RefreshCw className="w-3.5 h-3.5 animate-spin" />,
    label: 'Reconnecting...',
  };
```
  </action>
  <verify>
Run: `cd /Users/krunkosaurus/Documents/git/voice-cards && npm run typecheck`
TypeScript compiles without errors.
  </verify>
  <done>
SyncIndicator imports Popover, Button, RefreshCw icon, toast, and useSync. ConnectionState 'reconnecting' has orange styling with spinning RefreshCw icon. No onDisconnect prop needed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement popover with disconnect button and connection info</name>
  <files>client/src/components/SyncIndicator.tsx</files>
  <action>
Rewrite SyncIndicator component with popover using gracefulDisconnect from context:

```typescript
export function SyncIndicator({ state }: SyncIndicatorProps) {
  const {
    reconnectionState,
    connectedAt,
    syncState,
    resetReconnectionState,
    gracefulDisconnect,
  } = useSync();
  const [popoverOpen, setPopoverOpen] = useState(false);
  const prevStateRef = useRef<ConnectionState>(state);

  // Format connection duration
  const formatDuration = (startTime: number | null): string => {
    if (!startTime) return '--';
    const seconds = Math.floor((Date.now() - startTime) / 1000);
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ${seconds % 60}s`;
    const hours = Math.floor(minutes / 60);
    return `${hours}h ${minutes % 60}m`;
  };

  // Toast notifications for connection state changes (PRES-02)
  useEffect(() => {
    const prevState = prevStateRef.current;
    prevStateRef.current = state;

    // Don't toast on initial render or same state
    if (prevState === state) return;

    // Connection lost (PRES-02)
    if (prevState === 'connected' && (state === 'disconnected' || state === 'reconnecting')) {
      if (reconnectionState.status === 'peer_disconnected') {
        toast.info('Peer disconnected');
      } else {
        toast.error('Connection lost');
      }
    }

    // Connection established (PRES-01)
    if (state === 'connected' && prevState !== 'connected') {
      toast.success('Connected to peer');
    }
  }, [state, reconnectionState.status]);

  // Additional toast when reconnection fails
  useEffect(() => {
    if (reconnectionState.status === 'failed') {
      toast.error('Connection lost', {
        description: 'Please start a new session to reconnect.',
      });
    }
  }, [reconnectionState.status]);

  const config = getStateConfig(state);

  // Handle disconnect click - use gracefulDisconnect from context
  const handleDisconnect = async () => {
    setPopoverOpen(false);
    await gracefulDisconnect();
  };

  // Handle try again click
  const handleTryAgain = () => {
    setPopoverOpen(false);
    resetReconnectionState();
    // User will need to start new connection via ConnectionDialog
  };

  // Only show popover when connected or had a connection
  const showPopover = state === 'connected' ||
    reconnectionState.status === 'failed' ||
    reconnectionState.status === 'peer_disconnected';

  if (!showPopover) {
    // Simple badge without popover
    return (
      <Badge
        variant={config.variant}
        className={`gap-1.5 ${config.className}`}
      >
        {config.icon}
        <span className="hidden sm:inline">{config.label}</span>
      </Badge>
    );
  }

  return (
    <Popover open={popoverOpen} onOpenChange={setPopoverOpen}>
      <PopoverTrigger asChild>
        <Badge
          variant={config.variant}
          className={`cursor-pointer gap-1.5 ${config.className}`}
        >
          {config.icon}
          <span className="hidden sm:inline">{config.label}</span>
        </Badge>
      </PopoverTrigger>
      <PopoverContent className="w-56" align="end">
        <div className="space-y-3">
          {/* Connection info when connected */}
          {state === 'connected' && (
            <>
              <div className="text-sm space-y-1">
                <p className="flex justify-between">
                  <span className="text-muted-foreground">Duration:</span>
                  <span className="font-medium">{formatDuration(connectedAt)}</span>
                </p>
                <p className="flex justify-between">
                  <span className="text-muted-foreground">Role:</span>
                  <span className="font-medium capitalize">{syncState.role || 'Unknown'}</span>
                </p>
              </div>
              <Button
                variant="destructive"
                size="sm"
                className="w-full"
                onClick={handleDisconnect}
              >
                <X className="w-4 h-4 mr-2" />
                Disconnect
              </Button>
            </>
          )}

          {/* Failed reconnection state */}
          {reconnectionState.status === 'failed' && (
            <>
              <div className="text-sm text-center text-muted-foreground">
                Connection lost. Start a new session to reconnect.
              </div>
              <Button
                variant="outline"
                size="sm"
                className="w-full"
                onClick={handleTryAgain}
              >
                <RefreshCw className="w-4 h-4 mr-2" />
                Start New Session
              </Button>
            </>
          )}

          {/* Peer disconnected state */}
          {reconnectionState.status === 'peer_disconnected' && (
            <>
              <div className="text-sm text-center text-muted-foreground">
                Peer has disconnected from the session.
              </div>
              <Button
                variant="outline"
                size="sm"
                className="w-full"
                onClick={handleTryAgain}
              >
                <RefreshCw className="w-4 h-4 mr-2" />
                Start New Session
              </Button>
            </>
          )}
        </div>
      </PopoverContent>
    </Popover>
  );
}
```
  </action>
  <verify>
Run: `cd /Users/krunkosaurus/Documents/git/voice-cards && npm run typecheck`
TypeScript compiles without errors.
  </verify>
  <done>
SyncIndicator:
- Shows "Reconnecting..." when in reconnecting state (no attempt counter)
- Popover opens on click when connected/failed/peer_disconnected
- Connected popover shows duration, role, and Disconnect button
- Failed popover shows "Start New Session" button (not misleading "Try Again")
- Peer disconnected popover shows "Start New Session" button
- Toast notifications for connection lost/established/peer disconnected
- Uses gracefulDisconnect from useSync context (no prop drilling)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SyncIndicator usage in Home.tsx</name>
  <files>client/src/pages/Home.tsx</files>
  <action>
Update Home.tsx to remove onDisconnect prop since SyncIndicator now uses context:

1. Find where SyncIndicator is rendered (in header area)

2. Remove the onDisconnect prop - it's no longer needed:
```typescript
// Before (remove onDisconnect prop):
<SyncIndicator
  state={connectionState}
  onDisconnect={() => connectionRef.current?.gracefulDisconnect('user_initiated')}
/>

// After (simpler):
<SyncIndicator state={connectionState} />
```

The disconnect functionality is now handled internally via `gracefulDisconnect` from `useSync()` hook, which SyncIndicator calls directly. No prop drilling needed.
  </action>
  <verify>
Run: `cd /Users/krunkosaurus/Documents/git/voice-cards && npm run typecheck`
TypeScript compiles without errors.
  </verify>
  <done>
SyncIndicator usage simplified - no onDisconnect prop needed. Disconnect button wired to gracefulDisconnect via useSync context.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck` passes
2. SyncIndicator shows "Reconnecting..." when in reconnecting state (no attempt counter)
3. Clicking SyncIndicator when connected opens popover with:
   - Connection duration
   - User role
   - Disconnect button
4. Toast appears when connection is lost
5. Toast appears when peer disconnects
6. Toast appears when connected to peer
7. Disconnect button calls gracefulDisconnect from context (no prop)
</verification>

<success_criteria>
- CONN-07: Reconnecting state visible with "Reconnecting..." label
- CONN-08: Disconnect button in popover cleanly ends session via context
- PRES-01: Connected indicator shows peer is connected
- PRES-02: Toast notification when connection is lost
- Popover shows connection duration and role
- "Start New Session" button resets state for manual reconnection
</success_criteria>

<output>
After completion, create `.planning/phases/05-connection-polish/05-04-SUMMARY.md`
</output>
