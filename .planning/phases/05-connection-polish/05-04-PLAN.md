---
phase: 05-connection-polish
plan: 04
type: execute
wave: 4
depends_on: ["05-03"]
files_modified:
  - client/src/components/SyncIndicator.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 'Reconnecting...' state with attempt counter (CONN-07)"
    - "User can click disconnect button to end session (CONN-08)"
    - "User sees peer connected indicator (PRES-01)"
    - "User sees toast when connection is lost (PRES-02)"
  artifacts:
    - path: "client/src/components/SyncIndicator.tsx"
      provides: "Enhanced badge with reconnecting state, popover with disconnect button, toast notifications"
      contains: "PopoverContent"
  key_links:
    - from: "client/src/components/SyncIndicator.tsx"
      to: "client/src/contexts/SyncContext.tsx"
      via: "useSync hook for reconnectionState, connectedAt"
      pattern: "useSync"
    - from: "client/src/components/SyncIndicator.tsx"
      to: "sonner"
      via: "toast.error, toast.info, toast.success"
      pattern: "toast\\."
---

<objective>
Enhance SyncIndicator with reconnecting state display, popover disconnect button, and toast notifications.

Purpose: Implement PRES-01 (peer connected indicator), PRES-02 (connection lost notification), CONN-07 UI (reconnecting state), and CONN-08 UI (disconnect button). User always knows connection state and can cleanly end sessions.

Output: Enhanced SyncIndicator component with popover showing connection info and disconnect button, plus toast notifications for connection events.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-connection-polish/05-CONTEXT.md
@.planning/phases/05-connection-polish/05-RESEARCH.md
@.planning/phases/05-connection-polish/05-01-SUMMARY.md
@.planning/phases/05-connection-polish/05-02-SUMMARY.md
@.planning/phases/05-connection-polish/05-03-SUMMARY.md
@client/src/components/SyncIndicator.tsx
@client/src/components/ui/popover.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reconnecting state and popover imports</name>
  <files>client/src/components/SyncIndicator.tsx</files>
  <action>
Update imports and add new state handling:

1. Update imports at the top:
```typescript
import { useEffect, useRef, useState } from 'react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Wifi, WifiOff, Loader2, AlertCircle, RefreshCw, X } from 'lucide-react';
import { toast } from 'sonner';
import type { ConnectionState } from '@/types/sync';
import { useSync } from '@/contexts/SyncContext';
```

2. Update SyncIndicatorProps to include new fields:
```typescript
interface SyncIndicatorProps {
  state: ConnectionState;
  onDisconnect?: () => void;
}
```

3. Update getStateConfig to handle 'reconnecting' state (add case before 'error'):
```typescript
case 'reconnecting':
  return {
    variant: 'secondary' as const,
    className: 'bg-orange-500/10 text-orange-600 hover:bg-orange-500/20 border-orange-500/30',
    icon: <RefreshCw className="w-3.5 h-3.5 animate-spin" />,
    label: 'Reconnecting',
  };
```
  </action>
  <verify>
Run: `cd /Users/krunkosaurus/Documents/git/voice-cards && npm run typecheck`
TypeScript compiles without errors.
  </verify>
  <done>
SyncIndicator imports Popover, Button, RefreshCw icon, toast, and useSync. ConnectionState 'reconnecting' has orange styling with spinning RefreshCw icon.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement popover with disconnect button and connection info</name>
  <files>client/src/components/SyncIndicator.tsx</files>
  <action>
Rewrite SyncIndicator component with popover:

```typescript
export function SyncIndicator({ state, onDisconnect }: SyncIndicatorProps) {
  const { reconnectionState, connectedAt, syncState, resetReconnectionState } = useSync();
  const [popoverOpen, setPopoverOpen] = useState(false);
  const prevStateRef = useRef<ConnectionState>(state);

  // Format connection duration
  const formatDuration = (startTime: number | null): string => {
    if (!startTime) return '--';
    const seconds = Math.floor((Date.now() - startTime) / 1000);
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ${seconds % 60}s`;
    const hours = Math.floor(minutes / 60);
    return `${hours}h ${minutes % 60}m`;
  };

  // Toast notifications for connection state changes (PRES-02)
  useEffect(() => {
    const prevState = prevStateRef.current;
    prevStateRef.current = state;

    // Don't toast on initial render or same state
    if (prevState === state) return;

    // Connection lost (PRES-02)
    if (prevState === 'connected' && (state === 'disconnected' || state === 'reconnecting')) {
      if (reconnectionState.status === 'peer_disconnected') {
        toast.info('Peer disconnected');
      } else {
        toast.error('Connection lost', {
          description: state === 'reconnecting' ? 'Attempting to reconnect...' : undefined,
        });
      }
    }

    // Connection established (PRES-01)
    if (state === 'connected' && prevState !== 'connected') {
      toast.success('Connected to peer');
    }

    // Reconnection failed
    if (reconnectionState.status === 'failed') {
      toast.error('Reconnection failed', {
        description: 'Manual reconnection required.',
      });
    }
  }, [state, reconnectionState.status]);

  const config = getStateConfig(state);

  // Build label with reconnection attempt counter
  let displayLabel = config.label;
  if (state === 'reconnecting' && reconnectionState.status === 'reconnecting') {
    displayLabel = `Reconnecting (${reconnectionState.attempt}/${reconnectionState.maxAttempts})...`;
  }

  // Handle disconnect click
  const handleDisconnect = () => {
    setPopoverOpen(false);
    onDisconnect?.();
  };

  // Handle try again click
  const handleTryAgain = () => {
    setPopoverOpen(false);
    resetReconnectionState();
    // User will need to start new connection via ConnectionDialog
  };

  // Only show popover when connected or had a connection
  const showPopover = state === 'connected' ||
    reconnectionState.status === 'failed' ||
    reconnectionState.status === 'peer_disconnected';

  if (!showPopover) {
    // Simple badge without popover
    return (
      <Badge
        variant={config.variant}
        className={`gap-1.5 ${config.className}`}
      >
        {config.icon}
        <span className="hidden sm:inline">{displayLabel}</span>
      </Badge>
    );
  }

  return (
    <Popover open={popoverOpen} onOpenChange={setPopoverOpen}>
      <PopoverTrigger asChild>
        <Badge
          variant={config.variant}
          className={`cursor-pointer gap-1.5 ${config.className}`}
        >
          {config.icon}
          <span className="hidden sm:inline">{displayLabel}</span>
        </Badge>
      </PopoverTrigger>
      <PopoverContent className="w-56" align="end">
        <div className="space-y-3">
          {/* Connection info when connected */}
          {state === 'connected' && (
            <>
              <div className="text-sm space-y-1">
                <p className="flex justify-between">
                  <span className="text-muted-foreground">Duration:</span>
                  <span className="font-medium">{formatDuration(connectedAt)}</span>
                </p>
                <p className="flex justify-between">
                  <span className="text-muted-foreground">Role:</span>
                  <span className="font-medium capitalize">{syncState.role || 'Unknown'}</span>
                </p>
              </div>
              <Button
                variant="destructive"
                size="sm"
                className="w-full"
                onClick={handleDisconnect}
              >
                <X className="w-4 h-4 mr-2" />
                Disconnect
              </Button>
            </>
          )}

          {/* Failed reconnection state */}
          {reconnectionState.status === 'failed' && (
            <>
              <div className="text-sm text-center text-muted-foreground">
                Connection lost. Manual reconnection required.
              </div>
              <Button
                variant="outline"
                size="sm"
                className="w-full"
                onClick={handleTryAgain}
              >
                <RefreshCw className="w-4 h-4 mr-2" />
                Try Again
              </Button>
            </>
          )}

          {/* Peer disconnected state */}
          {reconnectionState.status === 'peer_disconnected' && (
            <>
              <div className="text-sm text-center text-muted-foreground">
                Peer has disconnected from the session.
              </div>
              <Button
                variant="outline"
                size="sm"
                className="w-full"
                onClick={handleTryAgain}
              >
                <RefreshCw className="w-4 h-4 mr-2" />
                Start New Session
              </Button>
            </>
          )}
        </div>
      </PopoverContent>
    </Popover>
  );
}
```
  </action>
  <verify>
Run: `cd /Users/krunkosaurus/Documents/git/voice-cards && npm run typecheck`
TypeScript compiles without errors.
  </verify>
  <done>
SyncIndicator:
- Shows reconnecting state with attempt counter: "Reconnecting (2/3)..."
- Popover opens on click when connected/failed/peer_disconnected
- Connected popover shows duration, role, and Disconnect button
- Failed popover shows "Try Again" button
- Peer disconnected popover shows "Start New Session" button
- Toast notifications for connection lost/established/peer disconnected
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire disconnect handler in Home.tsx</name>
  <files>client/src/pages/Home.tsx</files>
  <action>
Update Home.tsx to pass gracefulDisconnect to SyncIndicator:

1. Find where SyncIndicator is rendered (likely in the header area)

2. Update the SyncIndicator usage to include onDisconnect:
```typescript
<SyncIndicator
  state={connectionState}
  onDisconnect={() => {
    connectionRef.current?.gracefulDisconnect('user_initiated');
  }}
/>
```

Note: The exact location may be in Header.tsx or Home.tsx - find where connectionState is available and SyncIndicator is rendered.

If SyncIndicator is rendered from a parent component without direct access to connectionRef, you may need to:
- Add the onDisconnect prop to Home and pass it down, OR
- Import useSync in SyncIndicator and call gracefulDisconnect directly through the context

Alternative approach if connectionRef isn't available at SyncIndicator level:
Add to SyncContext:
```typescript
// In SyncContextValue interface:
gracefulDisconnect: () => Promise<void>;

// In provider:
const gracefulDisconnect = useCallback(async () => {
  await connectionRef.current?.gracefulDisconnect('user_initiated');
}, []);

// In context value:
gracefulDisconnect,
```

Then in SyncIndicator, use:
```typescript
const { gracefulDisconnect } = useSync();
// ...
onClick={gracefulDisconnect}
```
  </action>
  <verify>
Run: `cd /Users/krunkosaurus/Documents/git/voice-cards && npm run typecheck`
TypeScript compiles without errors.
  </verify>
  <done>
SyncIndicator Disconnect button wired to gracefulDisconnect. Clicking "Disconnect" sends disconnect message to peer and cleanly closes connection.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck` passes
2. SyncIndicator shows "Reconnecting (N/3)..." when in reconnecting state
3. Clicking SyncIndicator when connected opens popover with:
   - Connection duration
   - User role
   - Disconnect button
4. Toast appears when connection is lost
5. Toast appears when peer disconnects
6. Toast appears when connected to peer
7. Disconnect button calls gracefulDisconnect
</verification>

<success_criteria>
- CONN-07: Reconnecting state visible with attempt counter
- CONN-08: Disconnect button in popover cleanly ends session
- PRES-01: Connected indicator shows peer is connected
- PRES-02: Toast notification when connection is lost
- Popover shows connection duration and role
- "Try Again" button resets state for manual reconnection
</success_criteria>

<output>
After completion, create `.planning/phases/05-connection-polish/05-04-SUMMARY.md`
</output>
