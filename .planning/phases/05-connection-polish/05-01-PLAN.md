---
phase: 05-connection-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/types/sync.ts
  - client/src/services/webrtc/syncProtocol.ts
autonomous: true

must_haves:
  truths:
    - "Heartbeat message types exist for connection health monitoring"
    - "Disconnect message type exists for graceful disconnect"
    - "ConnectionState includes 'reconnecting' state"
  artifacts:
    - path: "client/src/types/sync.ts"
      provides: "HeartbeatPing, HeartbeatPong, DisconnectMessage interfaces, ConnectionState 'reconnecting'"
      contains: "HeartbeatPing"
    - path: "client/src/services/webrtc/syncProtocol.ts"
      provides: "createHeartbeatPing, createHeartbeatPong, createDisconnect, isHeartbeatMessage, isDisconnectMessage"
      contains: "createHeartbeatPing"
  key_links:
    - from: "client/src/services/webrtc/syncProtocol.ts"
      to: "client/src/types/sync.ts"
      via: "import HeartbeatPing, HeartbeatPong, DisconnectMessage"
      pattern: "import.*HeartbeatPing"
---

<objective>
Add heartbeat and disconnect message types to the sync protocol for connection health monitoring and graceful disconnect.

Purpose: Enable application-level detection of stale connections (WebRTC's SCTP heartbeat isn't exposed to JS) and distinguish between network failures (auto-reconnect) vs intentional disconnects (no reconnect).

Output: Extended type definitions and message creator functions for heartbeat ping/pong and disconnect messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-connection-polish/05-CONTEXT.md
@.planning/phases/05-connection-polish/05-RESEARCH.md
@client/src/types/sync.ts
@client/src/services/webrtc/syncProtocol.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add message types and ConnectionState to sync.ts</name>
  <files>client/src/types/sync.ts</files>
  <action>
Add the following to sync.ts:

1. Add 'reconnecting' to ConnectionState union type (after 'connected', before 'error'):
```typescript
| 'reconnecting'  // Attempting to recover connection
```

2. Add HeartbeatPing interface after RoleTransferCompleteMessage:
```typescript
/**
 * Heartbeat ping sent periodically to detect stale connections.
 * CONN-07: Connection health monitoring.
 */
export interface HeartbeatPing extends ControlMessage {
  type: 'heartbeat_ping';
  sentAt: number;  // Timestamp for RTT calculation
}
```

3. Add HeartbeatPong interface:
```typescript
/**
 * Response to heartbeat ping.
 * Echo back sentAt for RTT calculation.
 */
export interface HeartbeatPong extends ControlMessage {
  type: 'heartbeat_pong';
  sentAt: number;  // Echoed from ping for RTT calculation
}
```

4. Add DisconnectMessage interface:
```typescript
/**
 * Sent before intentionally closing connection.
 * Receiver should NOT auto-reconnect when receiving this.
 * CONN-08: Graceful disconnect.
 */
export interface DisconnectMessage extends ControlMessage {
  type: 'disconnect';
  reason: 'user_initiated' | 'error';
}
```

5. Add HeartbeatMessage union type:
```typescript
/**
 * Union type of heartbeat messages.
 */
export type HeartbeatMessage = HeartbeatPing | HeartbeatPong;
```

6. Update SyncControlMessage union to include these new types by adding:
   | HeartbeatPing
   | HeartbeatPong
   | DisconnectMessage
  </action>
  <verify>
Run: `cd /Users/krunkosaurus/Documents/git/voice-cards && npm run typecheck`
TypeScript compiles without errors.
  </verify>
  <done>
ConnectionState includes 'reconnecting'. HeartbeatPing, HeartbeatPong, DisconnectMessage, and HeartbeatMessage types exist in sync.ts. SyncControlMessage union includes all new message types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add message creators and type guards to syncProtocol.ts</name>
  <files>client/src/services/webrtc/syncProtocol.ts</files>
  <action>
Add the following to syncProtocol.ts:

1. Import the new types at the top:
```typescript
import type {
  // ... existing imports ...
  HeartbeatPing,
  HeartbeatPong,
  HeartbeatMessage,
  DisconnectMessage,
} from '@/types/sync';
```

2. Add message creators near other create* functions:
```typescript
/**
 * Create a heartbeat ping message.
 * Sent periodically to detect stale connections.
 */
export function createHeartbeatPing(): Omit<HeartbeatPing, 'timestamp' | 'id'> {
  return {
    type: 'heartbeat_ping',
    sentAt: Date.now(),
  };
}

/**
 * Create a heartbeat pong response.
 * Echoes back the ping's sentAt for RTT calculation.
 */
export function createHeartbeatPong(sentAt: number): Omit<HeartbeatPong, 'timestamp' | 'id'> {
  return {
    type: 'heartbeat_pong',
    sentAt,
  };
}

/**
 * Create a disconnect message.
 * Send before intentionally closing connection.
 */
export function createDisconnect(reason: 'user_initiated' | 'error'): Omit<DisconnectMessage, 'timestamp' | 'id'> {
  return {
    type: 'disconnect',
    reason,
  };
}
```

3. Add type guards near other is* functions:
```typescript
/**
 * Type guard for heartbeat messages.
 */
export function isHeartbeatMessage(msg: ControlMessage): msg is HeartbeatMessage {
  return msg.type === 'heartbeat_ping' || msg.type === 'heartbeat_pong';
}

/**
 * Type guard for disconnect message.
 */
export function isDisconnectMessage(msg: ControlMessage): msg is DisconnectMessage {
  return msg.type === 'disconnect';
}
```
  </action>
  <verify>
Run: `cd /Users/krunkosaurus/Documents/git/voice-cards && npm run typecheck`
TypeScript compiles without errors.
  </verify>
  <done>
createHeartbeatPing, createHeartbeatPong, createDisconnect functions exist. isHeartbeatMessage, isDisconnectMessage type guards exist. All exports are properly typed.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck` passes
2. New types exported: HeartbeatPing, HeartbeatPong, DisconnectMessage, HeartbeatMessage visible in sync.ts
3. Message creators exported: createHeartbeatPing, createHeartbeatPong, createDisconnect visible in syncProtocol.ts
4. Type guards exported: isHeartbeatMessage, isDisconnectMessage visible in syncProtocol.ts
</verification>

<success_criteria>
- ConnectionState type includes 'reconnecting'
- HeartbeatPing, HeartbeatPong, DisconnectMessage interfaces defined
- Message creator functions compile and return correct types
- Type guards correctly narrow ControlMessage to specific message types
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-connection-polish/05-01-SUMMARY.md`
</output>
