---
phase: 05-connection-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - client/src/services/webrtc/connection.ts
autonomous: true

must_haves:
  truths:
    - "Connection sends heartbeat pings every 5 seconds when connected"
    - "Connection responds to heartbeat pings with pongs"
    - "Connection detects timeout after 15 seconds of no pong"
    - "Connection can send disconnect message before closing"
  artifacts:
    - path: "client/src/services/webrtc/connection.ts"
      provides: "Heartbeat service, graceful disconnect, timeout callback"
      contains: "startHeartbeat"
  key_links:
    - from: "client/src/services/webrtc/connection.ts"
      to: "client/src/services/webrtc/syncProtocol.ts"
      via: "import createHeartbeatPing, createHeartbeatPong, createDisconnect"
      pattern: "createHeartbeatPing"
---

<objective>
Add heartbeat service and graceful disconnect to WebRTCConnectionService for connection health monitoring.

Purpose: Detect stale connections via application-level heartbeat (5s ping, 15s timeout = 3 missed pings) since WebRTC's SCTP heartbeat isn't exposed to JavaScript. Enable graceful disconnect by sending explicit message before closing.

Output: WebRTCConnectionService with heartbeat management and graceful disconnect capability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-connection-polish/05-CONTEXT.md
@.planning/phases/05-connection-polish/05-RESEARCH.md
@.planning/phases/05-connection-polish/05-01-SUMMARY.md
@client/src/services/webrtc/connection.ts
@client/src/services/webrtc/syncProtocol.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add heartbeat service to WebRTCConnectionService</name>
  <files>client/src/services/webrtc/connection.ts</files>
  <action>
Modify WebRTCConnectionService to add heartbeat functionality:

1. Add imports at top:
```typescript
import {
  createHeartbeatPing,
  createHeartbeatPong,
  isHeartbeatMessage,
  createDisconnect,
  isDisconnectMessage,
} from '@/services/webrtc/syncProtocol';
import type { HeartbeatPing, HeartbeatMessage, DisconnectMessage } from '@/types/sync';
```

2. Add new callback type to ConnectionCallbacks interface:
```typescript
export interface ConnectionCallbacks {
  onStateChange?: (state: ConnectionState) => void;
  onControlMessage?: (msg: ControlMessage) => void;
  onBinaryMessage?: (data: ArrayBuffer) => void;
  onHeartbeatTimeout?: () => void;  // Called when heartbeat times out (3 missed pings)
  onPeerDisconnect?: (reason: 'user_initiated' | 'error') => void;  // Called when peer sends disconnect
}
```

3. Add private fields for heartbeat management (after existing private fields):
```typescript
// Heartbeat management
private heartbeatInterval: ReturnType<typeof setInterval> | null = null;
private lastPongTime: number = 0;
private readonly HEARTBEAT_INTERVAL = 5000;  // 5s between pings
private readonly HEARTBEAT_TIMEOUT = 15000;  // 15s = 3 missed pings

// Callbacks
private onHeartbeatTimeout: (() => void) | null = null;
private onPeerDisconnect: ((reason: 'user_initiated' | 'error') => void) | null = null;
```

4. Update setCallbacks to include new callbacks:
```typescript
setCallbacks(callbacks: ConnectionCallbacks): void {
  if (callbacks.onStateChange) {
    this.onStateChange = callbacks.onStateChange;
  }
  if (callbacks.onControlMessage) {
    this.onControlMessage = callbacks.onControlMessage;
  }
  if (callbacks.onBinaryMessage) {
    this.onBinaryMessage = callbacks.onBinaryMessage;
  }
  if (callbacks.onHeartbeatTimeout) {
    this.onHeartbeatTimeout = callbacks.onHeartbeatTimeout;
  }
  if (callbacks.onPeerDisconnect) {
    this.onPeerDisconnect = callbacks.onPeerDisconnect;
  }
}
```

5. Add startHeartbeat method (public, called by SyncContext when connected):
```typescript
/**
 * Start sending heartbeat pings.
 * Call when connection is established.
 * Pings every 5s, times out after 15s (3 missed pongs).
 */
startHeartbeat(): void {
  this.stopHeartbeat();  // Clear any existing
  this.lastPongTime = Date.now();

  console.log('[WebRTC] Starting heartbeat (5s interval, 15s timeout)');

  this.heartbeatInterval = setInterval(() => {
    // Check for timeout
    const elapsed = Date.now() - this.lastPongTime;
    if (elapsed > this.HEARTBEAT_TIMEOUT) {
      console.warn('[WebRTC] Heartbeat timeout - no pong in 15s');
      this.stopHeartbeat();
      if (this.onHeartbeatTimeout) {
        this.onHeartbeatTimeout();
      }
      return;
    }

    // Send ping
    this.sendControl(createHeartbeatPing());
  }, this.HEARTBEAT_INTERVAL);
}
```

6. Add stopHeartbeat method:
```typescript
/**
 * Stop sending heartbeat pings.
 * Called on disconnect or heartbeat timeout.
 */
stopHeartbeat(): void {
  if (this.heartbeatInterval) {
    clearInterval(this.heartbeatInterval);
    this.heartbeatInterval = null;
    console.log('[WebRTC] Stopped heartbeat');
  }
}
```

7. Add receivePong method (called internally when pong received):
```typescript
/**
 * Record that a heartbeat pong was received.
 * Resets the timeout timer.
 */
private receivePong(): void {
  this.lastPongTime = Date.now();
}
```

8. Add gracefulDisconnect method:
```typescript
/**
 * Gracefully disconnect - send disconnect message before closing.
 * CONN-08: User can intentionally disconnect.
 *
 * @param reason - Why disconnecting (user_initiated or error)
 */
async gracefulDisconnect(reason: 'user_initiated' | 'error' = 'user_initiated'): Promise<void> {
  console.log('[WebRTC] Graceful disconnect:', reason);

  // Stop heartbeat first
  this.stopHeartbeat();

  // Send disconnect message if channel is still open
  if (this.controlChannel?.readyState === 'open') {
    this.sendControl(createDisconnect(reason));
    // Small delay to ensure message is sent before closing
    await new Promise(resolve => setTimeout(resolve, 100));
  }

  // Now disconnect
  this.disconnect();
}
```

9. Modify handleControlMessage to intercept heartbeat and disconnect messages:
```typescript
private handleControlMessage(data: string): void {
  try {
    const message = JSON.parse(data) as ControlMessage;

    // Handle heartbeat messages internally
    if (isHeartbeatMessage(message)) {
      this.handleHeartbeatMessage(message as HeartbeatMessage);
      return;  // Don't pass to external handler
    }

    // Handle disconnect message
    if (isDisconnectMessage(message)) {
      console.log('[WebRTC] Received disconnect message:', (message as DisconnectMessage).reason);
      this.stopHeartbeat();
      if (this.onPeerDisconnect) {
        this.onPeerDisconnect((message as DisconnectMessage).reason);
      }
      return;  // Don't pass to external handler
    }

    console.log('[WebRTC] Control message received:', message.type);

    if (this.onControlMessage) {
      this.onControlMessage(message);
    }
  } catch (error) {
    console.error('[WebRTC] Failed to parse control message:', error);
  }
}
```

10. Add handleHeartbeatMessage method:
```typescript
/**
 * Handle incoming heartbeat messages.
 * Ping: respond with pong
 * Pong: update lastPongTime
 */
private handleHeartbeatMessage(msg: HeartbeatMessage): void {
  if (msg.type === 'heartbeat_ping') {
    // Respond with pong, echoing the sentAt
    this.sendControl(createHeartbeatPong((msg as HeartbeatPing).sentAt));
  } else if (msg.type === 'heartbeat_pong') {
    this.receivePong();
  }
}
```

11. Update disconnect() method to also stop heartbeat:
```typescript
disconnect(): void {
  console.log('[WebRTC] Disconnecting...');

  // Stop heartbeat
  this.stopHeartbeat();

  // Close DataChannels (rest of existing code...)
  // ...
}
```
  </action>
  <verify>
Run: `cd /Users/krunkosaurus/Documents/git/voice-cards && npm run typecheck`
TypeScript compiles without errors.
  </verify>
  <done>
WebRTCConnectionService has:
- startHeartbeat() / stopHeartbeat() methods for heartbeat management
- gracefulDisconnect() method that sends disconnect message before closing
- onHeartbeatTimeout callback fired after 15s of no pong
- onPeerDisconnect callback fired when peer sends disconnect message
- Internal heartbeat ping/pong handling (not passed to external handlers)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck` passes
2. startHeartbeat() method exists and is public
3. stopHeartbeat() method exists and is public
4. gracefulDisconnect() method exists and is public
5. ConnectionCallbacks interface includes onHeartbeatTimeout and onPeerDisconnect
6. Heartbeat messages handled internally, not passed to onControlMessage
</verification>

<success_criteria>
- Heartbeat pings sent every 5 seconds when startHeartbeat() called
- Heartbeat pongs automatically sent in response to pings
- onHeartbeatTimeout callback fired after 15 seconds without pong
- gracefulDisconnect() sends disconnect message and waits 100ms before closing
- onPeerDisconnect callback fired when disconnect message received
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-connection-polish/05-02-SUMMARY.md`
</output>
