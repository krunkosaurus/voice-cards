---
phase: 04-editor-role-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/types/sync.ts
  - client/src/services/webrtc/syncProtocol.ts
autonomous: true

must_haves:
  truths:
    - "Role message types are defined for request/grant/deny/transfer_complete"
    - "Message creators follow existing pattern (MessageWithoutMeta)"
    - "Type guards recognize role messages"
  artifacts:
    - path: "client/src/types/sync.ts"
      provides: "Role message type definitions"
      contains: "RoleRequestMessage"
    - path: "client/src/services/webrtc/syncProtocol.ts"
      provides: "Role message creators and type guard"
      exports: ["createRoleRequest", "createRoleGrant", "createRoleDeny", "createRoleTransferComplete", "isRoleMessage"]
  key_links:
    - from: "client/src/types/sync.ts"
      to: "client/src/services/webrtc/syncProtocol.ts"
      via: "Type imports for message creators"
      pattern: "import.*RoleRequestMessage"
---

<objective>
Add role protocol message types and creators to the sync protocol.

Purpose: Enable role transfer negotiation between peers via WebRTC control channel.

Output: 4 new message types (role_request, role_grant, role_deny, role_transfer_complete) with creators and type guard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-editor-role-system/04-RESEARCH.md

# Files to modify
@client/src/types/sync.ts
@client/src/services/webrtc/syncProtocol.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add role message types to sync.ts</name>
  <files>client/src/types/sync.ts</files>
  <action>
Add 4 new message type interfaces after the existing SyncOperation types section.

Add these interfaces:

```typescript
// =============================================================================
// Role Transfer Protocol Message Types (ROLE-01 through ROLE-05)
// =============================================================================

/**
 * Viewer requests editor role from current editor.
 * ROLE-02: Viewer can request editor role.
 */
export interface RoleRequestMessage extends ControlMessage {
  type: 'role_request';
  reason?: string; // Optional: "I need to make edits"
}

/**
 * Editor grants editor role to viewer.
 * ROLE-03: Editor can approve request.
 */
export interface RoleGrantMessage extends ControlMessage {
  type: 'role_grant';
}

/**
 * Editor denies role request.
 * ROLE-03: Editor can deny request.
 */
export interface RoleDenyMessage extends ControlMessage {
  type: 'role_deny';
  reason?: string; // Optional: "Still editing"
}

/**
 * Sent by old editor after role swap completes to confirm transfer.
 * ROLE-05: Signals editing can resume after brief pause.
 */
export interface RoleTransferCompleteMessage extends ControlMessage {
  type: 'role_transfer_complete';
}

/**
 * Union type of all role transfer messages.
 */
export type RoleMessage =
  | RoleRequestMessage
  | RoleGrantMessage
  | RoleDenyMessage
  | RoleTransferCompleteMessage;
```

Also update the SyncControlMessage union type to include role messages:
- Add the 4 new message types to the union

The SyncControlMessage union should include:
  | RoleRequestMessage
  | RoleGrantMessage
  | RoleDenyMessage
  | RoleTransferCompleteMessage
  </action>
  <verify>npx tsc --noEmit (no type errors in sync.ts)</verify>
  <done>Role message interfaces exported from sync.ts, SyncControlMessage includes role messages</done>
</task>

<task type="auto">
  <name>Task 2: Add role message creators to syncProtocol.ts</name>
  <files>client/src/services/webrtc/syncProtocol.ts</files>
  <action>
Add role message creators and type guard to syncProtocol.ts.

1. Update imports from '@/types/sync' to include new types:
   - RoleRequestMessage
   - RoleGrantMessage
   - RoleDenyMessage
   - RoleTransferCompleteMessage
   - RoleMessage

2. Add ROLE_MESSAGE_TYPES constant (after OPERATION_MESSAGE_TYPES):

```typescript
/**
 * Role message type strings for role transfer protocol.
 * Used by isRoleMessage type guard.
 */
export const ROLE_MESSAGE_TYPES = [
  'role_request',
  'role_grant',
  'role_deny',
  'role_transfer_complete',
] as const;
```

3. Add message creators (after operation message creators):

```typescript
// =============================================================================
// Role Message Creators
// =============================================================================

/**
 * Create a role_request message.
 * Viewer sends this to request editor role.
 *
 * @param reason - Optional reason for request
 */
export function createRoleRequest(
  reason?: string
): MessageWithoutMeta<RoleRequestMessage> {
  return {
    type: 'role_request',
    reason,
  };
}

/**
 * Create a role_grant message.
 * Editor sends this to grant role to viewer.
 */
export function createRoleGrant(): MessageWithoutMeta<RoleGrantMessage> {
  return {
    type: 'role_grant',
  };
}

/**
 * Create a role_deny message.
 * Editor sends this to deny role request.
 *
 * @param reason - Optional reason for denial
 */
export function createRoleDeny(
  reason?: string
): MessageWithoutMeta<RoleDenyMessage> {
  return {
    type: 'role_deny',
    reason,
  };
}

/**
 * Create a role_transfer_complete message.
 * New editor sends this after confirming role swap.
 */
export function createRoleTransferComplete(): MessageWithoutMeta<RoleTransferCompleteMessage> {
  return {
    type: 'role_transfer_complete',
  };
}
```

4. Add type guard (after isSyncControlMessage):

```typescript
/**
 * Type guard to check if a ControlMessage is a RoleMessage.
 * Enables routing of role transfer protocol messages.
 *
 * @param msg - Any control message
 * @returns true if msg is a RoleMessage
 */
export function isRoleMessage(
  msg: ControlMessage
): msg is RoleMessage {
  return ROLE_MESSAGE_TYPES.includes(msg.type as typeof ROLE_MESSAGE_TYPES[number]);
}
```
  </action>
  <verify>npx tsc --noEmit (no type errors)</verify>
  <done>Role message creators and isRoleMessage type guard exported from syncProtocol.ts</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. sync.ts exports RoleRequestMessage, RoleGrantMessage, RoleDenyMessage, RoleTransferCompleteMessage, RoleMessage
3. syncProtocol.ts exports createRoleRequest, createRoleGrant, createRoleDeny, createRoleTransferComplete, isRoleMessage
4. SyncControlMessage union includes all role message types
</verification>

<success_criteria>
- Role message types defined following existing ControlMessage pattern
- Message creators follow MessageWithoutMeta pattern
- Type guard enables routing in message handlers
- No circular dependencies or type errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-editor-role-system/04-01-SUMMARY.md`
</output>
