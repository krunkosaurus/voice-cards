---
phase: 04-editor-role-system
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - client/src/components/RoleBadge.tsx
  - client/src/components/RoleRequestDialog.tsx
  - client/src/components/Header.tsx
autonomous: true

must_haves:
  truths:
    - "User can see their current role clearly displayed (ROLE-01)"
    - "Viewer can click to request editor role (ROLE-02)"
    - "Editor sees request notification and can approve or deny (ROLE-03)"
  artifacts:
    - path: "client/src/components/RoleBadge.tsx"
      provides: "Role indicator badge component"
      exports: ["RoleBadge"]
    - path: "client/src/components/RoleRequestDialog.tsx"
      provides: "Editor's approval dialog for role requests"
      exports: ["RoleRequestDialog"]
    - path: "client/src/components/Header.tsx"
      provides: "Integrates RoleBadge"
      contains: "RoleBadge"
  key_links:
    - from: "client/src/components/RoleBadge.tsx"
      to: "client/src/contexts/SyncContext.tsx"
      via: "Role transfer state for UI"
      pattern: "requestRole|roleTransferState"
    - from: "client/src/components/RoleRequestDialog.tsx"
      to: "client/src/contexts/SyncContext.tsx"
      via: "Grant/deny handlers"
      pattern: "grantRole|denyRole"
---

<objective>
Create role UI components for role indicator and request handling.

Purpose: Users can see their role and transfer editing rights between peers.

Output: RoleBadge component, RoleRequestDialog component, Header integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-editor-role-system/04-RESEARCH.md
@.planning/phases/04-editor-role-system/04-01-PLAN.md

# Files to reference
@client/src/components/SyncIndicator.tsx
@client/src/components/Header.tsx
@client/src/components/ConfirmDialog.tsx
@client/src/contexts/SyncContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RoleBadge component</name>
  <files>client/src/components/RoleBadge.tsx</files>
  <action>
Create a new component that shows the user's current role (ROLE-01) and allows viewers to request editor role (ROLE-02).

Follow the SyncIndicator.tsx pattern for styling.

```typescript
// components/RoleBadge.tsx - Role indicator badge
// Design: Visual indicator for user's editing role in header

import { Badge } from '@/components/ui/badge';
import { Pencil, Eye, Loader2 } from 'lucide-react';
import type { ConnectionState } from '@/types/sync';
import type { UserRole } from '@/contexts/SyncContext';

interface RoleTransferState {
  status: 'idle' | 'pending_request' | 'pending_approval' | 'transferring' | 'denied';
  reason?: string;
}

interface RoleBadgeProps {
  role: UserRole | null;
  connectionState: ConnectionState;
  roleTransferState: RoleTransferState;
  onRequestRole?: () => void;
}

export function RoleBadge({
  role,
  connectionState,
  roleTransferState,
  onRequestRole,
}: RoleBadgeProps) {
  // Don't show badge when not connected
  if (connectionState !== 'connected') {
    return null;
  }

  // Show loading state during role request
  if (roleTransferState.status === 'pending_request') {
    return (
      <Badge className="bg-yellow-500/10 text-yellow-600 border-yellow-500/30 gap-1.5">
        <Loader2 className="w-3.5 h-3.5 animate-spin" />
        <span className="hidden sm:inline">Requesting...</span>
      </Badge>
    );
  }

  // Show transferring state
  if (roleTransferState.status === 'transferring') {
    return (
      <Badge className="bg-blue-500/10 text-blue-600 border-blue-500/30 gap-1.5">
        <Loader2 className="w-3.5 h-3.5 animate-spin" />
        <span className="hidden sm:inline">Transferring...</span>
      </Badge>
    );
  }

  // Show denied state briefly
  if (roleTransferState.status === 'denied') {
    return (
      <Badge className="bg-red-500/10 text-red-600 border-red-500/30 gap-1.5">
        <Eye className="w-3.5 h-3.5" />
        <span className="hidden sm:inline">Denied</span>
      </Badge>
    );
  }

  // Editor badge
  if (role === 'editor') {
    return (
      <Badge className="bg-blue-500/10 text-blue-600 border-blue-500/30 gap-1.5">
        <Pencil className="w-3.5 h-3.5" />
        <span className="hidden sm:inline">Editing</span>
      </Badge>
    );
  }

  // Viewer badge - clickable to request role
  return (
    <Badge
      className="bg-gray-500/10 text-gray-600 border-gray-500/30 gap-1.5 cursor-pointer hover:bg-gray-500/20 transition-colors"
      onClick={onRequestRole}
      title="Click to request editor role"
    >
      <Eye className="w-3.5 h-3.5" />
      <span className="hidden sm:inline">Viewing</span>
    </Badge>
  );
}
```
  </action>
  <verify>npx tsc --noEmit (no type errors)</verify>
  <done>RoleBadge component created with role display and request trigger</done>
</task>

<task type="auto">
  <name>Task 2: Create RoleRequestDialog component</name>
  <files>client/src/components/RoleRequestDialog.tsx</files>
  <action>
Create a dialog that appears when editor has a pending role request (ROLE-03).

Follow the ConfirmDialog.tsx pattern for styling.

```typescript
// components/RoleRequestDialog.tsx - Role request approval dialog
// Design: Editor sees this when viewer requests editor role

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { UserPlus } from 'lucide-react';

interface RoleRequestDialogProps {
  isOpen: boolean;
  onGrant: () => void;
  onDeny: () => void;
}

export function RoleRequestDialog({
  isOpen,
  onGrant,
  onDeny,
}: RoleRequestDialogProps) {
  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && onDeny()}>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/20 mb-4">
            <UserPlus className="h-6 w-6 text-blue-600 dark:text-blue-400" />
          </div>
          <DialogTitle className="text-center">
            Editor Role Requested
          </DialogTitle>
          <DialogDescription className="text-center">
            Your peer wants to take over editing. If you grant the request,
            you will become a viewer and they will become the editor.
          </DialogDescription>
        </DialogHeader>

        <DialogFooter className="sm:justify-center gap-2 mt-4">
          <Button
            variant="outline"
            onClick={onDeny}
          >
            Deny
          </Button>
          <Button
            onClick={onGrant}
          >
            Grant Editor Role
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>npx tsc --noEmit (no type errors)</verify>
  <done>RoleRequestDialog component created for editor approval flow</done>
</task>

<task type="auto">
  <name>Task 3: Integrate RoleBadge into Header</name>
  <files>client/src/components/Header.tsx</files>
  <action>
Add RoleBadge to Header component next to SyncIndicator.

1. Add imports:
```typescript
import { RoleBadge } from './RoleBadge';
import type { UserRole } from '@/contexts/SyncContext';
```

2. Add new props to HeaderProps interface:
```typescript
interface HeaderProps {
  // ... existing props ...
  // Role display props
  role?: UserRole | null;
  roleTransferState?: {
    status: 'idle' | 'pending_request' | 'pending_approval' | 'transferring' | 'denied';
    reason?: string;
  };
  onRequestRole?: () => void;
}
```

3. Update function signature to include new props:
```typescript
export function Header({
  // ... existing props ...
  role,
  roleTransferState,
  onRequestRole,
}: HeaderProps) {
```

4. Add RoleBadge next to SyncIndicator in the actions div (before SyncIndicator):
```tsx
{/* Role indicator - only show when connected */}
{role && roleTransferState && (
  <RoleBadge
    role={role}
    connectionState={connectionState}
    roleTransferState={roleTransferState}
    onRequestRole={onRequestRole}
  />
)}

{/* Sync indicator */}
<SyncIndicator state={connectionState} onClick={onConnectClick} />
```

The RoleBadge should appear before the SyncIndicator in the header.
  </action>
  <verify>npx tsc --noEmit (no type errors)</verify>
  <done>Header displays RoleBadge next to SyncIndicator when connected</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. RoleBadge shows "Editing" for editor, "Viewing" for viewer
3. RoleBadge is clickable for viewer to request role
4. RoleBadge shows loading states during request/transfer
5. RoleRequestDialog shows for editor when request pending
6. Header integrates RoleBadge next to SyncIndicator
</verification>

<success_criteria>
- ROLE-01: User sees their role via RoleBadge ("Editing" or "Viewing")
- ROLE-02: Viewer can click RoleBadge to request role
- ROLE-03: Editor sees RoleRequestDialog with grant/deny options
- Badge states: Editing, Viewing, Requesting..., Transferring..., Denied
</success_criteria>

<output>
After completion, create `.planning/phases/04-editor-role-system/04-03-SUMMARY.md`
</output>
