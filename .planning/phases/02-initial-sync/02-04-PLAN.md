---
phase: 02-initial-sync
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - client/src/components/SyncProgress.tsx
  - client/src/components/OverwriteConfirmDialog.tsx
  - client/src/components/Header.tsx
  - client/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User sees progress bar during sync transfer (XFER-02)"
    - "User sees toast when sync completes (XFER-03)"
    - "User sees warning before existing project is overwritten (XFER-04)"
    - "Sync UI integrates with existing app structure"
    - "Auto-sync is wired up when connection established (XFER-01)"
  artifacts:
    - path: "client/src/components/SyncProgress.tsx"
      provides: "Progress bar and status display during sync"
      min_lines: 50
    - path: "client/src/components/OverwriteConfirmDialog.tsx"
      provides: "Confirmation dialog before overwriting local project"
      min_lines: 40
    - path: "client/src/App.tsx"
      provides: "SyncProvider integration"
      contains: "SyncProvider"
  key_links:
    - from: "client/src/components/SyncProgress.tsx"
      to: "client/src/contexts/SyncContext.tsx"
      via: "useSync hook"
      pattern: "useSync"
    - from: "client/src/components/OverwriteConfirmDialog.tsx"
      to: "client/src/contexts/SyncContext.tsx"
      via: "useSync hook"
      pattern: "useSync"
    - from: "client/src/App.tsx"
      to: "client/src/contexts/SyncContext.tsx"
      via: "SyncProvider"
      pattern: "SyncProvider"
    - from: "client/src/components/Header.tsx"
      to: "client/src/contexts/SyncContext.tsx"
      via: "setConnection and setUserRole for auto-sync"
      pattern: "setConnection|setUserRole"
---

<objective>
Create sync UI components and integrate SyncProvider into the app.

Purpose: Users need visual feedback during sync (XFER-02), confirmation when complete (XFER-03), and a warning before overwrite (XFER-04). This plan delivers those UI requirements and wires everything together. It also wires up the auto-sync trigger (XFER-01) by calling setConnection/setUserRole when WebRTC connects.

Output: SyncProgress component, OverwriteConfirmDialog component, App integration with SyncProvider, Header wiring for auto-sync.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-initial-sync/02-03-SUMMARY.md
@client/src/contexts/SyncContext.tsx
@client/src/components/ui/progress.tsx
@client/src/components/ui/dialog.tsx
@client/src/components/ui/alert-dialog.tsx
@client/src/components/ui/button.tsx
@client/src/components/Header.tsx
@client/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncProgress component</name>
  <files>client/src/components/SyncProgress.tsx</files>
  <action>
Create new file client/src/components/SyncProgress.tsx:

**Imports:**
- React from 'react'
- useSync from @/contexts/SyncContext
- Progress from @/components/ui/progress
- cn from @/lib/utils

**Component:**
```typescript
export function SyncProgress() {
  const { syncState } = useSync();

  // Don't render if not syncing or idle
  if (!syncState.isSyncing || syncState.progress.phase === 'idle') {
    return null;
  }

  const { progress, role } = syncState;
  const percent = progress.totalBytesTotal > 0
    ? Math.round((progress.totalBytesTransferred / progress.totalBytesTotal) * 100)
    : 0;

  const statusText = getStatusText(progress.phase, role, progress);

  return (
    <div className="fixed bottom-4 right-4 z-50 w-80 rounded-lg border bg-background p-4 shadow-lg">
      <div className="flex items-center gap-3">
        {progress.phase === 'transferring' && (
          <div className="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent" />
        )}
        <div className="flex-1">
          <p className="text-sm font-medium">{statusText}</p>
          {progress.phase === 'transferring' && (
            <>
              <Progress value={percent} className="mt-2 h-2" />
              <p className="mt-1 text-xs text-muted-foreground">
                Card {progress.currentCardIndex + 1} of {progress.totalCards} ({percent}%)
              </p>
            </>
          )}
        </div>
      </div>
    </div>
  );
}

function getStatusText(phase: string, role: SyncRole, progress: SyncProgress): string {
  switch (phase) {
    case 'requesting':
      return 'Preparing sync...';
    case 'awaiting_accept':
      return 'Waiting for peer to accept...';
    case 'transferring':
      return role === 'sender' ? 'Sending project...' : 'Receiving project...';
    case 'complete':
      return 'Sync complete!';
    case 'error':
      return `Error: ${progress.error || 'Unknown error'}`;
    default:
      return 'Syncing...';
  }
}
```

Style considerations:
- Fixed position bottom-right to not obstruct main UI
- Use existing Progress component from shadcn/ui
- Show spinner during active transfer
- Display card count and percentage
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Visually: Component renders correctly when syncState.isSyncing is true.
  </verify>
  <done>
SyncProgress component shows transfer status, progress bar, and card count during sync. Auto-hides when not syncing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OverwriteConfirmDialog component</name>
  <files>client/src/components/OverwriteConfirmDialog.tsx</files>
  <action>
Create new file client/src/components/OverwriteConfirmDialog.tsx:

**Imports:**
- React from 'react'
- useSync from @/contexts/SyncContext
- useProject from @/contexts/ProjectContext
- AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle from @/components/ui/alert-dialog

**Component:**
```typescript
export function OverwriteConfirmDialog() {
  const { syncState, acceptSync, rejectSync } = useSync();
  const { state } = useProject();

  // Show when we have a pending sync request
  const isOpen = syncState.pendingRequest !== null;

  // Count local cards to warn user
  const localCardCount = state.cards.length;
  const incomingCardCount = syncState.pendingRequest?.cards.length ?? 0;

  const handleAccept = () => {
    acceptSync();
  };

  const handleReject = () => {
    rejectSync('User declined sync');
  };

  return (
    <AlertDialog open={isOpen}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Incoming Project Sync</AlertDialogTitle>
          <AlertDialogDescription>
            {localCardCount > 0 ? (
              <>
                Your peer wants to sync their project with you. This will{' '}
                <strong>replace your current project</strong> ({localCardCount} cards) with theirs ({incomingCardCount} cards).
                <br /><br />
                This action cannot be undone. Are you sure you want to continue?
              </>
            ) : (
              <>
                Your peer wants to sync their project with you ({incomingCardCount} cards).
                <br /><br />
                Accept to receive their project.
              </>
            )}
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel onClick={handleReject}>
            Decline
          </AlertDialogCancel>
          <AlertDialogAction onClick={handleAccept}>
            {localCardCount > 0 ? 'Replace My Project' : 'Accept'}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

Key behaviors:
- Shows automatically when pendingRequest is set (receiver got sync_request)
- Warning tone when user has existing cards (destructive action)
- Friendly tone when user has no cards
- Accept triggers acceptSync(), Decline triggers rejectSync()
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Visually: Dialog appears when pendingRequest is set in SyncContext.
  </verify>
  <done>
OverwriteConfirmDialog warns user before their project is replaced. Different messaging for empty vs non-empty local project.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate SyncProvider, wire auto-sync, add toast and manual sync button</name>
  <files>client/src/App.tsx, client/src/components/Header.tsx</files>
  <action>
**Update App.tsx:**

1. Import SyncProvider from @/contexts/SyncContext
2. Import SyncProgress from @/components/SyncProgress
3. Import OverwriteConfirmDialog from @/components/OverwriteConfirmDialog

4. Wrap app content with SyncProvider (inside ProjectProvider, as it depends on useProject):
```tsx
<ProjectProvider>
  <SyncProvider>
    {/* existing content */}
    <SyncProgress />
    <OverwriteConfirmDialog />
  </SyncProvider>
</ProjectProvider>
```

**Update Header.tsx:**

The Header already has connection state and useWebRTC integration from Phase 1. Update it to:

1. Import useSync from @/contexts/SyncContext
2. Import toast from sonner (already in project)

3. **Wire up auto-sync (XFER-01):** When WebRTC connection is established, call SyncContext's setConnection and setUserRole:
```tsx
const { syncState, commitSync, startSync, setConnection, setUserRole } = useSync();
const { connection, connectionState } = useWebRTC(); // existing hook

// Wire connection to SyncContext for auto-sync (XFER-01)
useEffect(() => {
  if (connectionState === 'connected' && connection) {
    // Determine role: if we initiated the connection, we're the editor
    const isEditor = /* logic to determine if user initiated connection */;
    setUserRole(isEditor ? 'editor' : 'viewer');
    setConnection(connection);
  } else {
    setConnection(null);
  }
}, [connectionState, connection, setConnection, setUserRole]);
```

Note: The role determination depends on existing connection logic. If user clicks "Share" they are editor; if they enter a code they are viewer.

4. Add effect to show toast on sync completion (XFER-03):
```tsx
useEffect(() => {
  if (syncState.progress.phase === 'complete' && syncState.role === 'receiver') {
    // Commit the received project
    commitSync().then(() => {
      toast.success('Project synced successfully!', {
        description: `Received ${syncState.progress.totalCards} cards`,
      });
    });
  }
}, [syncState.progress.phase, syncState.role, commitSync]);
```

5. Add "Sync Project" button as **manual override/retry** (auto-sync is primary):
- Only show when connectionState === 'connected'
- Label indicates it's for manual sync: "Re-sync Project" or "Sync Now"
- onClick calls startSync with the connection from useWebRTC
- Disabled when syncState.isSyncing
- Only visible to editor role

```tsx
{connectionState === 'connected' && userRole === 'editor' && (
  <Button
    variant="outline"
    size="sm"
    onClick={() => startSync(connection)}
    disabled={syncState.isSyncing}
    title="Manually re-sync project to viewer"
  >
    <ArrowDownUp className="h-4 w-4 mr-2" />
    Sync Now
  </Button>
)}
```

Import ArrowDownUp from lucide-react.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Run `npm run dev` - app loads without errors.
Verify auto-sync wiring: grep for "setConnection" and "setUserRole" in Header.tsx.
Visually: When connection established as editor, auto-sync triggers. "Sync Now" button appears for manual retry.
  </verify>
  <done>
App wrapped with SyncProvider. SyncProgress and OverwriteConfirmDialog render globally. Header wires setConnection/setUserRole for auto-sync (XFER-01). Toast on completion (XFER-03). Manual "Sync Now" button available as override.
  </done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm run dev` starts without errors
- [ ] SyncProgress.tsx renders progress bar during sync
- [ ] OverwriteConfirmDialog.tsx shows when pendingRequest exists
- [ ] App.tsx wraps content with SyncProvider
- [ ] Header.tsx calls setConnection and setUserRole when WebRTC connects (XFER-01 wiring)
- [ ] Header.tsx has "Sync Now" button for manual sync/retry
- [ ] Header.tsx shows toast on sync completion (XFER-03)
</verification>

<success_criteria>
- XFER-01: Auto-sync triggered when editor connects (via setConnection/setUserRole wiring)
- XFER-02: Progress bar visible during transfer with card count and percentage
- XFER-03: Toast notification confirms sync completion
- XFER-04: Dialog warns receiver before overwriting existing project
- UI integrates cleanly with existing app structure
- No visual regressions to existing functionality
</success_criteria>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete initial sync UI: auto-sync on connection, progress bar, overwrite warning dialog, manual sync button, completion toast</what-built>
  <how-to-verify>
1. Open app in two browser windows
2. Establish P2P connection between them (use ConnectionDialog)
   - Window 1 clicks "Share" (becomes editor)
   - Window 2 enters code (becomes viewer)
3. XFER-01 Test: Verify sync starts AUTOMATICALLY when connection established (no button click needed)
4. Verify Window 2 shows OverwriteConfirmDialog
5. Click "Accept" in Window 2
6. Watch progress bar appear in both windows (XFER-02)
7. When complete, verify toast shows "Project synced successfully!" (XFER-03)
8. Verify Window 2 now has the same cards as Window 1
9. Test XFER-05: Play audio in Window 2 to confirm audio transferred correctly
10. Test manual sync: Click "Sync Now" in Window 1 to verify manual re-sync works
  </how-to-verify>
  <resume-signal>Type "approved" if sync flow works end-to-end, or describe issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/02-initial-sync/02-04-SUMMARY.md`
</output>
